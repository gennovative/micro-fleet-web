{"version":3,"sources":["app/RestCRUDControllerBase.ts"],"names":[],"mappings":"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","file":"RestCRUDControllerBase.js","sourcesContent":["import * as express from 'express';\r\nimport * as joi from 'joi';\r\nimport { decorate } from 'inversify';\r\nimport * as TrailsApp from 'trails';\r\nimport TrailsController = require('trails-controller');\r\n\r\nimport { injectable, unmanaged, Guard, HandlerContainer } from 'back-lib-common-util';\r\nimport {\r\n\tSettingItem, SettingItemDataType, ISoftDelRepository,\r\n\tModelAutoMapper, JoiModelValidator, PagedArray, ValidationError\r\n} from 'back-lib-common-contracts';\r\n\r\nimport { RestControllerBase, TrailsRouteConfigItem } from './RestControllerBase';\r\nimport { decorators } from './decorators';\r\nconst { controller, action } = decorators;\r\n\r\n\r\n@injectable()\r\nexport abstract class RestCRUDControllerBase<TModel extends IModelDTO> \r\n\textends RestControllerBase {\r\n\r\n\r\n\t/**\r\n\t * Generates Trails routes for CRUD operations.\r\n\t * @param {string} controllerDepIdentifier Key to look up and resolve from dependency container.\r\n\t * @param {boolean} isSoftDel Whether to add endpoints for `deleteSoft` and `recover`.\r\n\t * @param {string} pathPrefix Path prefix with heading slash and without trailing slash. Eg: /api/v1\r\n\t */\r\n\tpublic static createRoutes(controllerDepIdentifier: string, isSoftDel: boolean, pathPrefix: string = ''): TrailsRouteConfigItem[] {\r\n\t\tlet container = HandlerContainer.instance,\r\n\t\t\tgenFn = (method, action) => {\r\n\t\t\t\treturn RestControllerBase.createRoute(method, action,\r\n\t\t\t\t\tcontrollerDepIdentifier, pathPrefix, container);\r\n\t\t\t};\r\n\r\n\t\tlet routes = [\r\n\t\t\tgenFn('GET', ''),\r\n\t\t\tgenFn('POST', ''),\r\n\t\t\tgenFn('PUT', ''),\r\n\t\t\tgenFn('PATCH', ''),\r\n\t\t\tgenFn('DELETE', ''),\r\n\t\t\tgenFn('GET', 'countAll'),\r\n\t\t\tgenFn('GET', 'exists'),\r\n\t\t\tgenFn('GET', 'findByPk'),\r\n\t\t];\r\n\r\n\t\tisSoftDel && routes.push(\r\n\t\t\tgenFn('GET', 'recover')\r\n\t\t);\r\n\r\n\t\treturn routes;\r\n\t}\r\n\r\n\r\n\t// Should be overriden by derived class with:\r\n\t// @lazyInject(IDENTIFIER) private _repo: ISoftDelRepository<TModel, any, any>;\r\n\tprivate _repo: ISoftDelRepository<TModel, any, any>;\r\n\t\r\n\tconstructor(\r\n\t\t@unmanaged() trailsApp: TrailsApp,\r\n\t\t@unmanaged() protected _ClassDTO?: { new(): TModel }\r\n\t) {\r\n\t\tsuper(trailsApp);\r\n\t}\r\n\r\n\tprotected get repo(): ISoftDelRepository<TModel, any, any> {\r\n\t\treturn this._repo;\r\n\t}\r\n\r\n\tprotected get validator(): JoiModelValidator<TModel> {\r\n\t\treturn this._ClassDTO ? this._ClassDTO['validator'] : null;\r\n\t}\r\n\r\n\tprotected get translator(): ModelAutoMapper<TModel> {\r\n\t\treturn this._ClassDTO ? this._ClassDTO['translator'] : null;\r\n\t}\r\n\r\n\tprivate resolveTenant(tenantSlug: string) {\r\n\t\t// this._cache.\r\n\t}\r\n\r\n\t@action('GET', 'countAll')\r\n\tpublic async countAll(req: express.Request, res: express.Response) {\r\n\t\tconsole.log('Counting model');\r\n\t\ttry {\r\n\t\t\tlet nRows: number = await this.repo.countAll({\r\n\t\t\t\ttenantId: req.params.tenantId\r\n\t\t\t});\r\n\t\t\tthis.ok(res, nRows);\r\n\t\t} catch (err) {\r\n\t\t\tthis.internalError(res, err);\r\n\t\t}\r\n\t}\r\n\r\n\t@action('POST')\r\n\tpublic async create(req: express.Request, res: express.Response) {\r\n\t\tconsole.log('Creating model');\r\n\t\tlet payload = req.body(),\r\n\t\t\tdto: TModel = this.translator.whole(payload.model, {\r\n\t\t\t\terrorCallback: details => this.validationError(res, details)\r\n\t\t\t});\r\n\t\tif (!dto) { return; }\r\n\r\n\t\ttry {\r\n\t\t\tdto = await this.repo.create(dto);\r\n\t\t\tthis.created(res, dto);\r\n\t\t} catch (err) {\r\n\t\t\tthis.internalError(res, err);\r\n\t\t}\r\n\t}\r\n\r\n\t@action('DELETE', ':id')\r\n\tpublic async deleteHard(req: express.Request, res: express.Response) {\r\n\t\tconsole.log('Hard deleting model');\r\n\t\tlet { tenantId, id } = req.params,\r\n\t\t\t[err, pk] = this.validator.pk({ id, tenantId });\r\n\t\tif (!err) {\r\n\t\t\tthis.validationError(res, err);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\ttry {\r\n\t\t\tlet nRows: number = await this.repo.deleteHard(pk);\r\n\t\t\tthis.ok(res, nRows);\r\n\t\t} catch (err) {\r\n\t\t\tthis.internalError(res, err);\r\n\t\t}\r\n\t}\r\n\r\n\t@action('DELETE', 'soft/:id')\r\n\tpublic async deleteSoft(req: express.Request, res: express.Response) {\r\n\t\tconsole.log('Soft deleting model');\r\n\t\tlet { tenantId, id } = req.params,\r\n\t\t\t[err, pk] = this.validator.pk({ id, tenantId });\r\n\t\tif (!err) {\r\n\t\t\tthis.validationError(res, err);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\ttry {\r\n\t\t\tlet nRows: number = await this.repo.deleteSoft(pk);\r\n\t\t\tthis.ok(res, nRows);\r\n\t\t} catch (err) {\r\n\t\t\tthis.internalError(res, err);\r\n\t\t}\r\n\t}\r\n\r\n\t@action('GET', 'exists')\r\n\tpublic async exists(req: express.Request, res: express.Response) {\r\n\t\tconsole.log('Checking existence');\r\n\t\tlet uniqueProps = req.query;\r\n\t\ttry {\r\n\t\t\tlet gotIt: boolean = await this.repo.exists(uniqueProps, {\r\n\t\t\t\ttenantId: req.params.tenantId\r\n\t\t\t});\r\n\t\t\tthis.ok(res, gotIt);\r\n\t\t} catch (err) {\r\n\t\t\tthis.internalError(res, err);\r\n\t\t}\r\n\t}\r\n\r\n\t@action('GET', ':id')\r\n\tpublic async findByPk(req: express.Request, res: express.Response) {\r\n\t\tconsole.log('Finding model');\r\n\t\tlet { tenantId, id } = req.params,\r\n\t\t\t[err, pk] = this.validator.pk({ id, tenantId });\r\n\t\tif (!err) {\r\n\t\t\tthis.validationError(res, err);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\ttry {\r\n\t\t\tlet dto: TModel = await this.repo.findByPk(pk);\r\n\t\t\tthis.ok(res, dto);\r\n\t\t} catch (err) {\r\n\t\t\tthis.internalError(res, err);\r\n\t\t}\r\n\t}\r\n\r\n\t@action('GET', 'recover/:id')\r\n\tpublic async recover(req: express.Request, res: express.Response) {\r\n\t\tconsole.log('Recovering model');\r\n\t\tlet { tenantId, id } = req.params,\r\n\t\t\t[err, pk] = this.validator.pk({ id, tenantId });\r\n\t\tif (!err) {\r\n\t\t\tthis.validationError(res, err);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\ttry {\r\n\t\t\tlet nRows: number = await this.repo.recover(pk);\r\n\t\t\tthis.ok(res, nRows);\r\n\t\t} catch (err) {\r\n\t\t\tthis.internalError(res, err);\r\n\t\t}\r\n\t}\r\n\r\n\t@action('GET', ':pageIndex?/:pageSize?')\r\n\tpublic async page(req: express.Request, res: express.Response) {\r\n\t\tconsole.log('Paging model');\r\n\t\tlet pageIndex, pageSize;\r\n\t\ttry {\r\n\t\t\tpageIndex = joi.number().default(1).validate(req.params.pageIndex);\r\n\t\t\tpageSize = joi.number().default(25).validate(req.params.pageSize);\r\n\t\t} catch (err) {\r\n\t\t\tthis.validationError(res, new ValidationError(err.detail));\r\n\t\t\treturn;\r\n\t\t}\r\n\t\ttry {\r\n\t\t\tlet models: PagedArray<TModel> = await this.repo.page(pageIndex, pageSize, {\r\n\t\t\t\ttenantId: req.params.tenantId\r\n\t\t\t});\r\n\t\t\tthis.ok(res, models);\r\n\t\t} catch (err) {\r\n\t\t\tthis.internalError(res, err);\r\n\t\t}\r\n\t}\r\n\r\n\t@action('PATCH', '')\r\n\tpublic async patch(req: express.Request, res: express.Response) {\r\n\t\tconsole.log('Patching model');\r\n\t\tlet model = this.translator.partial(req.body, {\r\n\t\t\t\terrorCallback: err => this.validationError(res, err)\r\n\t\t\t});\r\n\t\tif (!model) { return; }\r\n\r\n\t\ttry {\r\n\t\t\tlet updatedProps: Partial<TModel> = await this.repo.patch(model);\r\n\t\t\tthis.ok(res, updatedProps);\r\n\t\t} catch (err) {\r\n\t\t\tthis.internalError(res, err);\r\n\t\t}\r\n\t}\r\n\r\n\t@action('PUT', '')\r\n\tpublic async update(req: express.Request, res: express.Response) {\r\n\t\tconsole.log('Updating model');\r\n\t\tlet model: TModel = this.translator.whole(req.body, {\r\n\t\t\t\terrorCallback: err => this.validationError(res, err)\r\n\t\t\t});\r\n\t\tif (!model) { return; }\r\n\r\n\t\ttry {\r\n\t\t\tlet updatedModel: TModel = await this.repo.update(model);\r\n\t\t\tthis.ok(res, updatedModel);\r\n\t\t} catch (err) {\r\n\t\t\tthis.internalError(res, err);\r\n\t\t}\r\n\t}\r\n}"]}