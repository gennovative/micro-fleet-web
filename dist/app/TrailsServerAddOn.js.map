{"version":3,"sources":["app/TrailsServerAddOn.ts"],"names":[],"mappings":"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","file":"TrailsServerAddOn.js","sourcesContent":["import TrailsApp = require('trails');\r\n\r\nimport { injectable, inject, IDependencyContainer, Guard, HandlerContainer,\r\n\tINewable, Types as CmT } from 'back-lib-common-util';\r\n\r\nimport { pushFilterToArray } from './decorators/filter';\r\nimport { TenantResolverFilter } from './filters/TenantResolverFilter';\r\nimport { ErrorHandlerFilter } from './filters/ErrorHandlerFilter';\r\nimport { serverContext } from './ServerContext';\r\nimport { MetaData } from './constants/MetaData';\r\nimport { Types as T } from './Types';\r\n\r\n\r\nconst INVERSIFY_INJECTABLE = 'inversify:paramtypes';\r\n\r\n@injectable()\r\nexport class TrailsServerAddOn implements IServiceAddOn {\r\n\r\n\tpublic pathPrefix: string;\r\n\r\n\tprotected _server: TrailsApp;\r\n\tprotected _onError: Function;\r\n\tprotected _globalFilters: any[];\r\n\r\n\r\n\tconstructor(\r\n\t\t@inject(CmT.DEPENDENCY_CONTAINER) depContainer: IDependencyContainer,\r\n\t\t@inject(T.TRAILS_OPTS) protected _trailsOpts: TrailsApp.TrailsAppOts\r\n\t) {\r\n\t\tserverContext.setDependencyContainer(depContainer);\r\n\t\tthis._onError = (err) => { };\r\n\t\tthis._globalFilters = [];\r\n\t}\r\n\r\n\r\n\tpublic get server(): TrailsApp {\r\n\t\treturn this._server;\r\n\t}\r\n\r\n\t/**\r\n\t * @see IServiceAddOn.init\r\n\t */\r\n\tpublic init(): Promise<void> {\r\n\t\tGuard.assertIsDefined(this.pathPrefix, '`TrailsServerAddOn.pathPrefix` must be set!');\r\n\t\tserverContext.setPathPrefix(this.pathPrefix);\r\n\r\n\t\tthis.addErrorHandlerFilter();\r\n\r\n\t\tthis.buildConfig();\r\n\t\tthis._server = new TrailsApp(this._trailsOpts);\r\n\t\tserverContext.dependencyContainer.bindConstant(T.TRAILS_APP, this._server);\r\n\t\treturn <any>this._server.start()\r\n\t\t\t.catch(err => this._server.stop(err));\r\n\t}\r\n\r\n\t/**\r\n\t * @see IServiceAddOn.deadLetter\r\n\t */\r\n\tpublic deadLetter(): Promise<void> {\r\n\t\treturn Promise.resolve();\r\n\t}\r\n\r\n\t/**\r\n\t * @see IServiceAddOn.dispose\r\n\t */\r\n\tpublic dispose(): Promise<void> {\r\n\t\treturn <any>this._server.stop();\r\n\t}\r\n\r\n\tpublic onError(cb: (err) => void): void {\r\n\t\tthis._onError = cb;\r\n\t}\r\n\r\n\tpublic addErrorHandlerFilter(): void {\r\n\t\tthis.addGlobalFilter(ErrorHandlerFilter, f => f.handle, 9);\r\n\t}\r\n\r\n\tpublic addTenantResolverFilter(): void {\r\n\t\tthis.addGlobalFilter(TenantResolverFilter, f => f.resolve, 9);\r\n\t}\r\n\r\n\t/**\r\n\t * Registers a global-scoped filter which is called on every coming request.\r\n\t * @param FilterClass \r\n\t * @param filterFunc \r\n\t * @param priority \r\n\t */\r\n\tpublic addGlobalFilter<T>(FilterClass: INewable<T>, filterFunc: (filter: T) => Function, priority?: number): void {\r\n\t\tpushFilterToArray(this._globalFilters, FilterClass, filterFunc, priority);\r\n\t}\r\n\r\n\r\n\tprotected buildConfig(): void {\r\n\t\tlet config = this._trailsOpts.config,\r\n\t\t\troutes: any[] = config.routes || [],\r\n\t\t\tctrlFilters: Function[];\r\n\r\n\t\tthis.buildGlobalScopeFilters();\r\n\r\n\t\tfor (let ctrlName of Object.getOwnPropertyNames(this._trailsOpts.api.controllers)) {\r\n\t\t\tlet CtrlClass = this._trailsOpts.api.controllers[ctrlName];\r\n\t\t\tif (typeof CtrlClass !== 'function' || !Reflect.hasOwnMetadata(MetaData.CONTROLLER, CtrlClass)) {\r\n\t\t\t\tcontinue;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t// Clone array to make sure global filters are executed before controller ones.\r\n\t\t\tctrlFilters = this._globalFilters.slice();\r\n\t\t\tthis.buildControllerConfigs(CtrlClass, routes, ctrlFilters);\r\n\t\t}\r\n\r\n\t\tconfig.routes = routes;\r\n\t}\r\n\r\n\tprotected buildControllerConfigs(CtrlClass: Function, routes: TrailsRouteConfigItem[], ctrlFilters: Function[]): void {\r\n\t\tlet [path] = this.popMetadata(MetaData.CONTROLLER, CtrlClass),\r\n\t\t\tisGetSetter = (proto, funcName) => {\r\n\t\t\t\tlet desc = Object.getOwnPropertyDescriptor(proto, funcName);\r\n\t\t\t\treturn (desc && (desc.get || desc.set));\r\n\t\t\t};\r\n\r\n\t\tthis.buildControllerScopeFilters(CtrlClass, ctrlFilters);\r\n\r\n\t\tlet allFunctions: Function[] = [],\r\n\t\t\tactionFunc;\r\n\t\t// Iterates over all function in prototype chain, except root Object.prototype\r\n\t\tfor (let proto = CtrlClass.prototype; proto != Object.prototype; proto = Object.getPrototypeOf(proto)) {\r\n\t\t\tfor (let actionName of Object.getOwnPropertyNames(proto)) {\r\n\t\t\t\tif (actionName == 'constructor' || isGetSetter(proto, actionName)) { continue; }\r\n\t\t\t\tactionFunc = proto[actionName];\r\n\t\t\t\tif (typeof actionFunc !== 'function' || !Reflect.hasMetadata(MetaData.ACTION, CtrlClass, actionName)) { continue; }\r\n\r\n\t\t\t\t// Let actions in derived class override actions in super class.\r\n\t\t\t\tallFunctions.unshift(actionFunc);\r\n\t\t\t}\r\n\t\t}\r\n\t\tfor (actionFunc of allFunctions) {\r\n\t\t\troutes.push(this.buildActionRoute(CtrlClass, actionFunc, path));\r\n\t\t\tthis.buildActionFilters(CtrlClass, ctrlFilters, actionFunc);\r\n\t\t}\r\n\t}\r\n\r\n\tprotected buildActionRoute(CtrlClass: any, actionFunc: Function, controllerPath: string): TrailsRouteConfigItem {\r\n\t\tlet [method, path] = this.popMetadata(MetaData.ACTION, CtrlClass, actionFunc.name),\r\n\t\t\troutePath = `${serverContext.pathPrefix}${controllerPath}${path}`,\r\n\t\t\tthisAddon = this;\r\n\r\n\t\treturn <TrailsRouteConfigItem> {\r\n\t\t\tmethod,\r\n\t\t\tpath: routePath,\r\n\t\t\t// handler: `${CtrlClass.name}.${actionFunc.name}`\r\n\t\t\t// handler: HandlerContainer.instance.register(actionFunc.name, controllerIdentifier)\r\n\t\t\t\r\n\t\t\t// Creates new controller for each request.\r\n\t\t\thandler: function (/*req, res, next*/) {\r\n\t\t\t\t// Only keep \"req\" and \"res\" in arguments list.\r\n\t\t\t\tlet args = <IArguments><any>Array.prototype.slice.call(<any>arguments, 0, 2),\r\n\t\t\t\t\tctrl = thisAddon.instantiateClass(CtrlClass, false, thisAddon._server);\r\n\t\t\t\tthisAddon.executeFilters(CtrlClass, ctrl, actionFunc, args);\r\n\t\t\t}\r\n\t\t};\r\n\t}\r\n\r\n\tprotected buildGlobalScopeFilters(): void {\r\n\t\tlet filters = [];\r\n\t\tthis._globalFilters.reverse().forEach(p => {\r\n\t\t\tlet [FilterClass, funcName] = p;\r\n\t\t\tfilters.push(this.bindFuncWithFilterInstance(FilterClass, funcName));\r\n\t\t});\r\n\t\tthis._globalFilters = filters;\r\n\t}\r\n\r\n\tprotected buildControllerScopeFilters(CtrlClass: Function, ctrlFilters: Function[]): void {\r\n\t\tlet metaFilters: any[][] = this.popMetadata(MetaData.CONTROLLER_FILTER, CtrlClass);\r\n\t\tif (!metaFilters || !metaFilters.length) { return; }\r\n\r\n\t\t// `reverse()`: Policies with priority of greater number should run before ones with less priority.\r\n\t\t// filters = [\r\n\t\t//\t\t5: [ [FilterClass, funcName], [FilterClass, funcName] ]\r\n\t\t//\t\t1: [ [FilterClass, funcName], [FilterClass, funcName] ]\r\n\t\t// ]\r\n\t\tlet FilterClass, funcName;\r\n\t\tfor (let pFilters of metaFilters.reverse()) {\r\n\t\t\tfor (let f of pFilters) { // 1: [ [FilterClass, funcName], [FilterClass, funcName] ]\r\n\t\t\t\t[FilterClass, funcName] = f;\r\n\t\t\t\tctrlFilters.push(\r\n\t\t\t\t\t\tthis.bindFuncWithFilterInstance(FilterClass, funcName)\r\n\t\t\t\t\t);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tprotected bindFuncWithFilterInstance(FilterClass: INewable<any>, funcName: string): Function {\r\n\t\tlet filter = this.instantiateClass(FilterClass, true);\r\n\t\treturn filter[funcName].bind(filter);\r\n\t}\r\n\r\n\tprotected instantiateClass(TargetClass: INewable<any>, isSingleton: boolean, arg1?: any, arg2?: any, arg3?: any, arg4?: any, arg5?: any): any {\r\n\t\t// Create an instance either from dependency container or with normay way.\r\n\t\t// Make sure this instance is singleton.\r\n\t\tif (!Reflect.hasOwnMetadata(INVERSIFY_INJECTABLE, TargetClass)) {\r\n\t\t\treturn this.instantiateClassTraditionally(TargetClass, isSingleton, arg1, arg2, arg3, arg4, arg5);\r\n\t\t}\r\n\t\tlet instance = this.instantiateClassFromContainer(TargetClass, isSingleton);\r\n\t\tGuard.assertIsDefined(instance, \r\n\t\t\t`Class \"${TargetClass.name}\" is decorated with @injectable, but cannot be resolved. \r\n\t\t\tMake sure its class name is bound as dependency identifier, or its constructor arguments are resolved successfully.`);\r\n\t\treturn instance;\r\n\t}\r\n\r\n\tprotected instantiateClassFromContainer(TargetClass: INewable<any>, isSingleton: boolean): any {\r\n\t\tlet container: IDependencyContainer = serverContext.dependencyContainer;\r\n\t\tif (!container.isBound(TargetClass.name)) {\r\n\t\t\tlet bindResult = container.bind(TargetClass.name, TargetClass);\r\n\t\t\tisSingleton && bindResult.asSingleton();\r\n\t\t}\r\n\t\treturn container.resolve(TargetClass.name);\r\n\t}\r\n\r\n\tprotected instantiateClassTraditionally(TargetClass: INewable<any>, isSingleton: boolean, arg1?: any, arg2?: any, arg3?: any, arg4?: any, arg5?: any): any {\r\n\t\tif (isSingleton) {\r\n\t\t\treturn TargetClass['__instance'] ? TargetClass['__instance'] : (TargetClass['__instance'] = new TargetClass(arg1, arg2, arg3, arg4, arg5));\r\n\t\t}\r\n\t\treturn new TargetClass(arg1, arg2, arg3, arg4, arg5);\r\n\t}\r\n\r\n\tprotected buildActionFilters(CtrlClass: Function, ctrlFilters: Function[], actionFunc: Function): void {\r\n\t\tlet funcName = actionFunc.name,\r\n\t\t\tmetaPolicies: any[][] = this.popMetadata(MetaData.ACTION_FILTER, CtrlClass, funcName);\r\n\r\n\t\tlet ctrlName = CtrlClass.name,\r\n\t\t\t// Clone array. Controller filters will be executed before action's own filters.\r\n\t\t\tactFilters = ctrlFilters.slice();\r\n\r\n\t\tif (metaPolicies) {\r\n\t\t\t// `reverse()`: Policies with priority of greater number should run before ones with less priority.\r\n\t\t\tmetaPolicies.reverse().forEach(p => {\r\n\t\t\t\t//actPolicies.push(`${p[0]}.${p[1]}`); // Expect: \"PolicyClassName.functionName\"\r\n\t\t\t\tlet [FilterClass, funcName] = p;\r\n\t\t\t\tactFilters.push(\r\n\t\t\t\t\t\tthis.bindFuncWithFilterInstance(FilterClass, funcName)\r\n\t\t\t\t\t);\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t\t// Save these filters and will execute them whenever\r\n\t\t// a request is routed to this action.\r\n\t\tReflect.defineMetadata(MetaData.ACTION_FILTER, actFilters, CtrlClass, funcName);\r\n\t}\r\n\r\n\tprotected popMetadata(metaKey: string, classOrProto: any, propName?: string): any {\r\n\t\tlet metadata = (propName)\r\n\t\t\t? Reflect.getMetadata(metaKey, classOrProto, propName)\r\n\t\t\t: Reflect.getOwnMetadata(metaKey, classOrProto);\r\n\t\tReflect.deleteMetadata(metaKey, classOrProto, propName);\r\n\t\treturn metadata;\r\n\t}\r\n\r\n\r\n\tprivate executeFilters(CtrlClass: INewable<T>, ctrlIns: typeof CtrlClass, actionFunc: Function, requestArgs: IArguments): void {\r\n\t\tlet filters: Function[] = Reflect.getMetadata(MetaData.ACTION_FILTER, CtrlClass, actionFunc.name),\r\n\t\t\tnextChain: Function[] = [];\r\n\r\n\t\t// At the end of the chain, execute the target action.\r\n\t\tnextChain[filters.length - 1] = function () { actionFunc.apply(ctrlIns, requestArgs); };\r\n\r\n\t\t// Inside filter[i] function, when it calls \"next()\",\r\n\t\t// the filter[i+1] will be executed, and so forth...\r\n\t\tfor (let i = filters.length - 2; i >= 0; i--) {\r\n\t\t\tnextChain[i] = function() {\r\n\t\t\t\tfilters[i + 1].apply(null, [...requestArgs, nextChain[i + 1]]);\r\n\t\t\t};\r\n\t\t}\r\n\r\n\t\t// Now, invoke the first filter in chain.\r\n\t\tfilters[0].apply(null, [...requestArgs, nextChain[0]]);\r\n\t}\r\n}"]}