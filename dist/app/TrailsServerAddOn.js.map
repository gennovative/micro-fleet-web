{"version":3,"sources":["app/TrailsServerAddOn.ts"],"names":[],"mappings":"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","file":"TrailsServerAddOn.js","sourcesContent":["import TrailsApp = require('trails');\r\n\r\nimport { injectable, inject, IDependencyContainer, Guard, HandlerContainer,\r\n\tTypes as CmT } from 'back-lib-common-util';\r\n\r\nimport { serverContext } from './ServerContext';\r\nimport { MetaData } from './constants/MetaData';\r\nimport { Types as T } from './Types';\r\n\r\n\r\n\r\n@injectable()\r\nexport class TrailsServerAddOn implements IServiceAddOn {\r\n\r\n\tpublic pathPrefix: string;\r\n\r\n\tprotected _server: TrailsApp;\r\n\tprotected _onError: Function;\r\n\r\n\r\n\tconstructor(\r\n\t\t@inject(CmT.DEPENDENCY_CONTAINER) depContainer: IDependencyContainer,\r\n\t\t@inject(T.TRAILS_OPTS) protected _trailsOpts: TrailsApp.TrailsAppOts\r\n\t) {\r\n\t\tserverContext.setDependencyContainer(depContainer);\r\n\t\tthis._onError = (err) => { };\r\n\t}\r\n\r\n\r\n\tpublic get server(): TrailsApp {\r\n\t\treturn this._server;\r\n\t}\r\n\r\n\t/**\r\n\t * @see IServiceAddOn.init\r\n\t */\r\n\tpublic init(): Promise<void> {\r\n\t\tGuard.assertIsDefined(this.pathPrefix, '`TrailsServerAddOn.pathPrefix` must be set!');\r\n\t\tserverContext.setPathPrefix(this.pathPrefix);\r\n\r\n\t\tthis.registerRoutes();\r\n\t\tthis._server = new TrailsApp(this._trailsOpts);\r\n\t\tserverContext.dependencyContainer.bindConstant(T.TRAILS_APP, this._server);\r\n\t\treturn <any>this._server.start()\r\n\t\t\t.catch(err => this._server.stop(err));\r\n\t}\r\n\r\n\t/**\r\n\t * @see IServiceAddOn.deadLetter\r\n\t */\r\n\tpublic deadLetter(): Promise<void> {\r\n\t\treturn Promise.resolve();\r\n\t}\r\n\r\n\t/**\r\n\t * @see IServiceAddOn.dispose\r\n\t */\r\n\tpublic dispose(): Promise<void> {\r\n\t\treturn <any>this._server.stop();\r\n\t}\r\n\r\n\tpublic onError(cb: (err) => void): void {\r\n\t\tthis._onError = cb;\r\n\t}\r\n\r\n\r\n\tprotected registerRoutes(): void {\r\n\t\tlet routes: any[] = this._trailsOpts.config.routes;\r\n\t\tif (!routes) {\r\n\t\t\troutes = [];\r\n\t\t}\r\n\r\n\t\tfor (let ctrlName of Object.getOwnPropertyNames(this._trailsOpts.api.controllers)) {\r\n\t\t\tlet CtrlClass = this._trailsOpts.api.controllers[ctrlName];\r\n\t\t\tif (typeof CtrlClass !== 'function' || !Reflect.hasOwnMetadata(MetaData.CONTROLLER, CtrlClass)) {\r\n\t\t\t\tcontinue;\r\n\t\t\t}\r\n\r\n\t\t\tthis.buildControllerRoutes(CtrlClass, routes);\r\n\t\t}\r\n\t\tthis._trailsOpts.config.routes = routes;\r\n\t}\r\n\r\n\tprotected buildControllerRoutes(CtrlClass: Function, routes: TrailsRouteConfigItem[]): void {\r\n\t\tlet [depIdentifier, path] = Reflect.getOwnMetadata(MetaData.CONTROLLER, CtrlClass);\r\n\t\tfor (let actionName of Object.getOwnPropertyNames(CtrlClass.prototype)) {\r\n\t\t\tlet actionFunc = CtrlClass.prototype[actionName];\r\n\t\t\tif (typeof actionFunc !== 'function' || !Reflect.hasOwnMetadata(MetaData.ACTION, actionFunc)) {\r\n\t\t\t\tcontinue;\r\n\t\t\t}\r\n\r\n\t\t\troutes.push(this.buildActionRoute(CtrlClass.prototype[actionName], path, depIdentifier));\r\n\t\t}\r\n\t}\r\n\r\n\tprotected buildActionRoute(actionFunc: Function, controllerPath: string, controllerIdentifier: string): TrailsRouteConfigItem {\r\n\t\tlet [method, path] = Reflect.getOwnMetadata(MetaData.ACTION, actionFunc),\r\n\t\t\troutePath = `${serverContext.pathPrefix}${controllerPath}${path}`;\r\n\r\n\t\treturn <TrailsRouteConfigItem> {\r\n\t\t\tmethod,\r\n\t\t\tpath: routePath,\r\n\t\t\thandler: HandlerContainer.instance.register(actionFunc.name, controllerIdentifier)\r\n\t\t};\r\n\t}\r\n}"]}